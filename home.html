<!DOCTYPE html>
<html>
<script>
    var numThreads = 600;
</script>
<input id="urlIn" type="url" placeholder="Enter URL here (For eg. http://domain.com/file)" />
<input id="download_button" value="Download Now" type="button"></input>
<br />
<br />
<p id="progress">

</p>

<progress value="0" max="100" id="downloadProgress"></progress>
<br />
<br />
<div id="partprogresses">

</div>
<script>
    let urlIn = document.getElementById("urlIn");
    let button = document.getElementById("download_button");
    let progressText = document.getElementById("progress");
    let progressBar = document.getElementById("downloadProgress");
    let partprogressesHolder = document.getElementById("partprogresses");
    let partprogresses = [];
    let partprogressestext = [];
    for (let i = 0; i < numThreads; i++) {
        partprogresses[i] = document.createElement('progress');
        partprogressestext[i] = document.createElement('p');
        partprogresses[i].value = 0;
        partprogresses[i].max = 100;
        partprogressesHolder.appendChild(partprogresses[i]);
        partprogressesHolder.appendChild(partprogressestext[i]);
        //partprogressesHolder.appendChild(document.createElement('br'));
    }

    const { ipcRenderer } = require('electron');
    const filesize = function humanFileSize(bytes, si = false, dp = 1) {
        const thresh = si ? 1000 : 1024;

        if (Math.abs(bytes) < thresh) {
            return bytes + ' B';
        }

        const units = si
            ? ['kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB']
            : ['KiB', 'MiB', 'GiB', 'TiB', 'PiB', 'EiB', 'ZiB', 'YiB'];
        let u = -1;
        const r = 10 ** dp;

        do {
            bytes /= thresh;
            ++u;
        } while (Math.round(Math.abs(bytes) * r) / r >= thresh && u < units.length - 1);


        return bytes.toFixed(dp) + ' ' + units[u];
    };
    let cancelled = false;
    button.addEventListener("click", () => {


        if (button.value != 'Cancel') {
            ipcRenderer.send('download-start', urlIn.value, urlIn.value.substring(urlIn.value.lastIndexOf('/') + 1), numThreads);
            button.value = 'Cancel';
        }
        else
            ipcRenderer.send('cancel-download', null);
    });
    ipcRenderer.on('merging', (e, args) => {
        progressText.innerHTML = "Merging";
    });
    ipcRenderer.on('part-progress', (e, completed, total, partnum) => {
        partprogresses[partnum].value = Math.trunc((completed * 100) / total);
        partprogressestext[partnum].innerHTML = filesize(completed) + " of " + filesize(total);
    });
    ipcRenderer.on('progress', (e, completed, total) => {
        if (!cancelled) {
            progressText.innerHTML = filesize(completed) + " of " + filesize(total);
            progressBar.value = Math.trunc((completed * 100) / total);
            progressBar.style.color = '#8888FF';
        }
    });
    ipcRenderer.on('completed', (e, args) => {
        progressText.innerHTML = "Completed";
        progressBar.style.color = '#88FF88';
        progressBar.value = 100;
    });
    ipcRenderer.on('failed', (e) => {
        if (e != 'Cancelled' && !cancelled) {
            progressText.innerHTML = "Failed!";
        }
        else {
            progressText.innerHTML = "Cancelled";
            cancelled = true;
        }
        progressBar.style.color = '#FF8888';
        progressBar.value = 100;
    });

</script>

</html>